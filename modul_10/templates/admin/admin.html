<!DOCTYPE html>
<html lang="id">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />

    <title>Admin - Kelola Produk</title>

    <style>
      .product-image {
        max-width: 90px;
        object-fit: cover;
        cursor: pointer;
      }
    </style>
  </head>

  <body class="bg-light">
    <div class="container mt-4 mb-4">
      <div class="d-flex justify-content-between align-items-center mb-3">
        <h3>Admin - Kelola Produk</h3>

        <div class="d-flex gap-2">
          <a href="/add" class="btn btn-primary"> + Tambah Produk </a>
          <a href="/" class="btn btn-outline-secondary"> Halaman Utama </a>
        </div>
      </div>
      <form id="categoryForm">
        <input
          type="text"
          id="nama_kategori"
          placeholder="Nama kategori"
          required
        />
        <button type="submit">Tambah</button>
      </form>

      <div id="alert-container"></div>

      <div class="row mb-3">
        <div class="col-md-6">
          <input
            id="search-input"
            class="form-control"
            placeholder="Cari produk..."
          />
        </div>
        <div class="col-md-6">
          <select id="category-filter" class="form-select">
            <option value="">Semua Kategori</option>
          </select>
        </div>
      </div>

      <table class="table table-bordered table-striped align-middle">
        <thead class="table-dark">
          <tr>
            <th>ID</th>
            <th>Gambar</th>
            <th>Nama</th>
            <th>Deskripsi</th>
            <th>Kategori</th>
            <th>Harga</th>
            <th>Aksi</th>
          </tr>
        </thead>
        <tbody id="products-table">
          <tr>
            <td colspan="6" class="text-center text-muted">Memuat...</td>
          </tr>
        </tbody>
      </table>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.bundle.min.js"></script>

    <script>
      let allProducts = [];
      let categories = [];

      async function loadCategories() {
        const res = await fetch("/api/categories");
        categories = await res.json();
        const select = document.getElementById("category-filter");

        categories.forEach((c) => {
          const opt = document.createElement("option");
          opt.value = c.id;
          opt.textContent = c.nama_kategori;
          select.appendChild(opt);
        });
      }

      async function loadProducts() {
        const res = await fetch("/api/admin/products");
        allProducts = await res.json();
        displayProducts(allProducts);
      }

      function displayProducts(products) {
        const tbody = document.getElementById("products-table");
        if (!products.length) {
          tbody.innerHTML =
            '<tr><td colspan="6" class="text-center">Tidak ada data</td></tr>';
          return;
        }

        tbody.innerHTML = products
          .map(
            (p) => `
      <tr>
        <td>${p.id}</td>
        <td>${
          p.gambar
            ? `<img src="${p.gambar}" class="product-image img-thumbnail">`
            : "-"
        }</td>
        <td>${p.nama_produk}</td>
        <td class="text-truncate" style="max-width:250px">${
          p.deskripsi || "-"
        }</td>
        <td>${p.kategori || "-"}</td>
        <td>Rp ${Number(p.harga).toLocaleString("id-ID")}</td>
        <td>
          <a href="/edit/${p.id}" class="btn btn-warning btn-sm">Edit</a>
          <button class="btn btn-danger btn-sm" onclick="deleteProduct(${
            p.id
          })">Hapus</button>
        </td>
      </tr>
    `
          )
          .join("");
      }

      async function deleteProduct(id) {
        if (!confirm("Yakin hapus produk ini?")) return;
        const res = await fetch(`/api/admin/products/${id}`, {
          method: "DELETE",
        });
        const data = await res.json();
        showAlert(data.message || "Dihapus", res.ok ? "success" : "danger");
        loadProducts();
      }

      // SEARCH CLIENT SIDE
      document.getElementById("search-input").addEventListener("input", (e) => {
        const q = e.target.value.toLowerCase();
        displayProducts(
          allProducts.filter((p) => p.nama_produk.toLowerCase().includes(q))
        );
      });

      // FILTER CATEGORY
      document
        .getElementById("category-filter")
        .addEventListener("change", async (e) => {
          const id = e.target.value;
          if (!id) return displayProducts(allProducts);
          const res = await fetch(`/api/admin/products?category=${id}`);
          displayProducts(await res.json());
        });

      function showAlert(msg, type) {
        document.getElementById("alert-container").innerHTML = `
      <div class="alert alert-${type} alert-dismissible fade show">
        ${msg}
        <button class="btn-close" data-bs-dismiss="alert"></button>
      </div>`;
      }
      document
        .getElementById("categoryForm")
        .addEventListener("submit", async (e) => {
          e.preventDefault();

          const nama = document.getElementById("nama_kategori").value;

          const res = await fetch("/api/admin/categories", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            credentials: "include",
            body: JSON.stringify({ nama_kategori: nama }),
          });

          const data = await res.json();

          if (!res.ok) {
            alert(data.error);
            return;
          }

          alert("Kategori berhasil ditambahkan");
          location.reload();
        });

      loadCategories();
      loadProducts();
    </script>
  </body>
</html>
